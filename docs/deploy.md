# Концепция развертывания и управления приложением InfoRadar

Этот документ описывает финальную, согласованную архитектуру и план работ по созданию системы конфигурации, сборки, развертывания и обновления приложения InfoRadar.

## 1. Управление конфигурацией

Будет реализована двухуровневая система конфигурации для разделения настроек окружения и настроек приложения.

### 1.1. Уровень 1: Локальный файл `user_config.yml`

-   **Назначение:** Хранение параметров, специфичных для окружения конкретного пользователя и не предназначенных для синхронизации. В первую очередь — путь к файлу базы данных.
-   **Расположение:** Путь к файлу будет определяться с помощью библиотеки `appdirs` для соответствия стандартам ОС:
    -   **Linux:** `~/.config/inforadar/user_config.yml`
    -   **Windows:** `C:\Users\<USER>\AppData\Roaming\inforadar\user_config.yml`
-   **API Ключи:** Хранение ключей в этом файле **не предусматривается**. Реализация безопасного хранения с помощью системного хранилища (библиотека `keyring`) отложена до внедрения функционала, требующего эти ключи.

### 1.2. Уровень 2: Таблица `settings` в БД

-   **Назначение:** Хранение всех остальных настроек приложения, которые пользователь может изменять через UI.
-   **Структура таблицы:**
    | Поле          | Тип         | Назначение                                             |
    |---------------|-------------|--------------------------------------------------------|
    | `key`         | `TEXT`      | Уникальный ключ настройки (например, `fetch.habr.hubs`) |
    | `value`       | `TEXT`      | Значение настройки в виде строки                       |
    | `type`        | `TEXT`      | Тип данных (`integer`, `boolean`, `string`, `list`)    |
    | `description` | `TEXT`      | Описание настройки для UI                              |
-   **Вложенность:** Древовидная структура настроек эмулируется через "точечную нотацию" в поле `key`.
-   **Работа с типами:** Приложение будет использовать поле `type` для корректной интерпретации строкового `value` и для отображения соответствующего элемента управления в UI (например, чекбокс для `boolean`).

## 2. Управление базой данных

-   **Инструмент:** Для управления миграциями схемы БД будет использоваться **Alembic**.
-   **Процесс:** Миграции будут применяться **неявно и автоматически** при каждом запуске приложения. Приложение будет вызывать команду `upgrade head` программно, чтобы гарантировать актуальность схемы БД без каких-либо действий со стороны пользователя.

## 3. Сборка и развертывание

### 3.1. Оркестрация сборки

-   **Инструмент:** `Makefile` будет использоваться для оркестрации всего процесса.
-   **CI/CD:** Сборка под разные платформы будет автоматизирована с помощью **GitHub Actions**. Будет создан workflow с двумя параллельными задачами:
    -   Job 1 на `ubuntu-latest` для сборки Linux-версии.
    -   Job 2 на `windows-latest` для сборки Windows-версии.
-   **Публикация:** Финальная задача в workflow будет публиковать собранные артефакты на **GitHub Releases**, используя GitHub CLI (`gh`).

### 3.2. Установка на целевые системы

-   **Windows:**
    -   **Инструмент:** **NSIS** (Nullsoft Scriptable Install System) — как бесплатное и open-source решение.
    -   **Исполняемый файл:** `PyInstaller` будет собирать приложение в один файл `ir.exe`.
    -   **Инсталлятор:** Будет создан `setup.exe`, который предоставит стандартный мастер установки, скопирует `ir.exe` в `Program Files` и предложит опцию добавления каталога приложения в системную переменную `PATH`.
-   **Linux:**
    -   **Исполняемый файл:** `PyInstaller` будет собирать приложение в файл `inforadar`.
    -   **Распространение:** Через `.tar.gz` архив, содержащий бинарник и скрипт `install.sh`.
    -   **Установка:** Скрипт `sudo ./install.sh` будет копировать `inforadar` в `/usr/local/bin` и создавать символическую ссылку `ir` на него для удобства вызова: `sudo ln -sf /usr/local/bin/inforadar /usr/local/bin/ir`.

## 4. Система автоматических обновлений

### 4.1. Логика обновления

1.  Приложение при запуске делает запрос к API GitHub Releases для проверки наличия новой версии.
2.  Локальная версия (хранящаяся в `pyproject.toml` и доступная через `importlib.metadata`) сравнивается с версией в теге релиза.
3.  При наличии новой версии в UI появляется уведомление.
4.  После подтверждения пользователя приложение скачивает соответствующий артефакт (`.tar.gz` или `setup.exe`) во временную директорию.

### 4.2. Управление правами доступа

-   **Принцип:** Приложение всегда работает с правами обычного пользователя. Повышение прав запрашивается **только для самого акта установки обновления**.
-   **Windows:** Повышение прав будет запрошено автоматически через системный **UAC (User Account Control)** при запуске скачанного инсталлятора.
-   **Linux (Desktop):** Приложение будет использовать `pkexec` для вызова скрипта-установщика обновления. Это инициирует системный графический диалог для ввода пароля.
-   **Linux (Headless/Server):** Приложение определит отсутствие графической сессии (по переменной `DISPLAY`) и вместо `pkexec` выведет пользователю инструкцию с командой `sudo`, которую необходимо выполнить вручную.

## 5. Прочие ключевые детали

-   **Хранение версии:** Единым источником правды для версии приложения является файл `pyproject.toml` (`[project].version`).
-   **Псевдоним `ir`:** Реализуется через имя файла в Windows (`ir.exe`) и симлинк в Linux.
-   **Пути к файлам:** Для определения путей к `user_config.yml` и `inforadar.db` будет использоваться библиотека `appdirs`.
